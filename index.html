<!-- index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#ff4d8d" />
  <title>Be My Valentine üíñ</title>
  <style>
    :root{
      --bg1:#ff5aa5;
      --bg2:#ff3b6a;
      --bg3:#ffd1e3;
      --card:#ffffffee;
      --text:#2a0f1c;
      --muted:#5a2a3c;
      --yes1:#ff2f7a;
      --yes2:#ff6aa8;
      --no1:#d9d9e3;
      --no2:#f0f0f6;
      --shadow: 0 18px 50px rgba(0,0,0,.18);
      --radius: 22px;
      --btnH: 56px;
      --focus: 0 0 0 4px rgba(255, 47, 122, .25);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      overflow:hidden;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(255,255,255,.35), transparent 50%),
        radial-gradient(900px 500px at 80% 20%, rgba(255,255,255,.22), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2) 55%, var(--bg3));
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }

    /* Floating hearts background */
    .bg-hearts{
      position:fixed;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index:0;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.08));
    }
    .bg-hearts .h{
      position:absolute;
      width:18px;
      height:18px;
      background: rgba(255,255,255,.35);
      transform: rotate(45deg);
      border-radius: 4px;
      opacity:.75;
      animation: floatUp linear infinite;
      will-change: transform, top, left, opacity;
    }
    .bg-hearts .h::before,
    .bg-hearts .h::after{
      content:"";
      position:absolute;
      width:18px;
      height:18px;
      background: rgba(255,255,255,.35);
      border-radius: 50%;
    }
    .bg-hearts .h::before{ left:-9px; top:0; }
    .bg-hearts .h::after{ left:0; top:-9px; }

    @keyframes floatUp{
      0%   { transform: translate3d(0, 12vh, 0) rotate(45deg) scale(var(--s,1)); opacity:0; }
      10%  { opacity:.65; }
      100% { transform: translate3d(0, -120vh, 0) rotate(45deg) scale(var(--s,1)); opacity:0; }
    }

    /* App layout */
    .wrap{
      width:min(560px, 100%);
      z-index:2;
      display:flex;
      flex-direction:column;
      gap:14px;
      align-items:stretch;
    }

    .card{
      position:relative;
      z-index:2;
      background: var(--card);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border:1px solid rgba(255,255,255,.65);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 22px 18px 18px;
      overflow:hidden;
    }

    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(240px 120px at 18% 10%, rgba(255,47,122,.18), transparent 55%),
        radial-gradient(260px 140px at 88% 18%, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(260px 180px at 50% 110%, rgba(255,59,106,.12), transparent 55%);
      pointer-events:none;
    }

    .content{
      position:relative;
      z-index:1;
      text-align:center;
      padding: 6px 8px 10px;
    }

    h1{
      margin: 6px 0 10px;
      font-size: clamp(28px, 5.6vw, 40px);
      line-height:1.12;
      letter-spacing:-0.3px;
      text-shadow: 0 1px 0 rgba(255,255,255,.4);
    }

    .sub{
      margin: 0 auto 10px;
      max-width: 40ch;
      color: var(--muted);
      font-size: 1.05rem;
      line-height:1.45;
      min-height: 3.2em;
    }

    .buttons{
      position:relative;
      z-index:2;
      height: calc(var(--btnH) * 2 + 14px);
      display:block;
      margin: 8px 0 4px;
    }

    button{
      border:none;
      border-radius: 999px;
      height: var(--btnH);
      padding: 0 18px;
      font-weight: 800;
      font-size: 1.1rem;
      letter-spacing: .2px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 10px 24px rgba(0,0,0,.14);
      transition: transform .08s ease, box-shadow .12s ease, filter .12s ease;
      touch-action: manipulation;
    }
    button:active{ transform: translateY(1px) scale(.99); }
    button:focus-visible{ outline:none; box-shadow: var(--shadow), var(--focus); }

    #yesBtn{
      position:absolute;
      left:50%;
      top: 0;
      transform: translateX(-50%);
      width: min(92%, 360px);
      color:white;
      background: linear-gradient(135deg, var(--yes1), var(--yes2));
      text-shadow: 0 1px 0 rgba(0,0,0,.14);
    }
    #yesBtn:disabled{
      opacity: .65;
      filter: grayscale(.15);
      cursor: not-allowed;
      transform: translateX(-50%);
      box-shadow: 0 8px 18px rgba(0,0,0,.10);
    }
    #yesBtn:hover{ filter: brightness(1.03); }
    #yesBtn .shine{
      position:absolute;
      inset:0;
      border-radius:999px;
      overflow:hidden;
      pointer-events:none;
    }
    #yesBtn .shine::after{
      content:"";
      position:absolute;
      width:120px;
      height:120px;
      left:-140px;
      top:-30px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), rgba(255,255,255,0) 60%);
      transform: rotate(15deg);
      animation: shine 2.8s ease-in-out infinite;
      opacity:.8;
    }
    @keyframes shine{
      0%{ transform: translateX(0) rotate(15deg); opacity:.55; }
      45%{ opacity:.85; }
      100%{ transform: translateX(520px) rotate(15deg); opacity:.45; }
    }

    /* "No" button is a decoy */
    #noBtn{
      position:absolute;
      left:50%;
      top: calc(var(--btnH) + 14px);
      transform: translateX(-50%);
      width: min(92%, 360px);
      background: linear-gradient(135deg, var(--no2), var(--no1));
      color: #4a3a45;
      cursor: default;
      pointer-events:none; /* Not clickable */
      box-shadow: 0 10px 18px rgba(0,0,0,.10);
    }

    .hint{
      position:relative;
      z-index:1;
      margin: 12px auto 0;
      font-size: .95rem;
      color: rgba(58,18,34,.7);
    }

    .type{
      display:block;
      white-space: pre-line;
    }

    .rotate{
      margin: 10px auto 0;
      font-size: .95rem;
      color: rgba(58,18,34,.72);
      min-height: 1.2em;
    }

    /* When NO disappears ‚Üí extra romantic mode */
    body.valentine-mode{
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(255,255,255,.38), transparent 50%),
        radial-gradient(900px 500px at 80% 20%, rgba(255,255,255,.26), transparent 55%),
        linear-gradient(135deg, #ff7eb3, #ff4d6d 55%, #ffe0ea);
    }

    body.valentine-mode #yesBtn{
      filter: brightness(1.05);
      box-shadow: 0 14px 34px rgba(255, 47, 122, .35);
      animation: yesPulse 900ms ease-in-out infinite;
    }

    @keyframes yesPulse{
      0%,100%{ transform: translateX(-50%) scale(1); }
      50%{ transform: translateX(-50%) scale(1.03); }
    }

    /* Heart rain layer (always visible, but hearts are spawned by JS) */
    .heart-rain{
      position:fixed;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index:0;
      display:block;
    }

    /* Overlay heart rain layer (for overlay celebration) */
    .overlay-heart-rain{
      position:absolute;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      
    }

    /* Heart pieces (background = gentler, overlay = more celebratory) */
    .heart-rain b,
    .overlay-heart-rain b{
      position:absolute;
      transform: rotate(45deg);
      border-radius: 3px;
      animation: rain linear forwards;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.12));
      will-change: transform, top, left, opacity;
    }

    /* Keep heart shape/size identical everywhere; only change intensity */
    .heart-rain b{
      width:16px;
      height:16px;
      background: rgba(255,255,255,.98);
      opacity:.06; /* gentler background */
    }

    .overlay-heart-rain b{
      width:16px;
      height:16px;
      background: rgba(255,255,255,.98);
      opacity:.10; /* still festive */
    }
    .heart-rain b::before,
    .heart-rain b::after,
    .overlay-heart-rain b::before,
    .overlay-heart-rain b::after{
      content:"";
      position:absolute;
      width:16px;
      height:16px;
      background: rgba(255,255,255,.98);
      border-radius: 50%;
    }
    .heart-rain b::before,
    .overlay-heart-rain b::before{ left:-8px; top:0; }
    .heart-rain b::after,
    .overlay-heart-rain b::after{ left:0; top:-8px; }

    @keyframes rain{
      0%{ transform: translate3d(0,-24vh,0) rotate(45deg) scale(var(--s,1)); opacity:0; }
      10%{ opacity:.55; }
      100%{ transform: translate3d(var(--dx,0px), 115vh, 0) rotate(45deg) scale(var(--s,1)); opacity:.45; }
    }

    footer{
      text-align:center;
      color: rgba(255,255,255,.92);
      font-weight: 650;
      text-shadow: 0 2px 10px rgba(0,0,0,.18);
      font-size: .98rem;
      padding-bottom: 4px;
    }

    /* Overlay steps ("pages") */
    .overlay-step{ display:none; }
    .overlay-step.show{ display:block; }

    .step-nav{
      margin: 14px auto 0;
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .step-nav .cta{
      border:none;
      border-radius: 999px;
      padding: 12px 16px;
      background: rgba(255,255,255,.92);
      color: #2a0f1c;
      font-weight: 900;
      box-shadow: 0 12px 28px rgba(0,0,0,.16);
      cursor:pointer;
    }
    .step-nav .cta:active{ transform: translateY(1px) scale(.99); }

    /* Celebration overlay */
    .overlay{
      position:fixed;
      inset:0;
      background:
        radial-gradient(900px 600px at 50% 10%, rgba(255,255,255,.25), transparent 55%),
        linear-gradient(135deg, rgba(255,47,122,.96), rgba(255,106,168,.90), rgba(255,209,227,.94));
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10;
      overflow:hidden;
    }
    .overlay.show{ display:flex; }

    .celebrate{
      text-align:center;
      padding: 24px 18px;
      width:min(680px, 100%);
    }
    .celebrate h2{
      margin:0 0 10px;
      color:white;
      font-size: clamp(34px, 7vw, 56px);
      line-height:1.05;
      text-shadow: 0 10px 30px rgba(0,0,0,.2);
    }
    .celebrate p{
      margin: 0 auto;
      max-width: 40ch;
      color: rgba(255,255,255,.95);
      font-size: 1.15rem;
      line-height:1.4;
      text-shadow: 0 8px 22px rgba(0,0,0,.16);
    }

    .date-chooser{
      margin: 18px auto 0;
      max-width: 520px;
      display:grid;
      gap:12px;
    }

    .date-chooser .question{
      margin: 0 auto 8px;
      color: rgba(255,255,255,.98);
      font-weight: 750;
      letter-spacing: .2px;
      font-size: 1.05rem;
      text-shadow: 0 8px 22px rgba(0,0,0,.16);
    }

    .date-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    @media (min-width: 520px){
      .date-grid{ grid-template-columns: repeat(2, 1fr); }
    }

    @media (min-width: 780px){
      .date-grid{ grid-template-columns: repeat(4, 1fr); }
    }

    .date-option{
      border:none;
      border-radius: 18px;
      padding: 14px 12px;
      background: rgba(255,255,255,.18);
      color: rgba(255,255,255,.98);
      box-shadow: 0 10px 26px rgba(0,0,0,.14);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      cursor:pointer;
      transition: transform .08s ease, filter .12s ease, box-shadow .12s ease;
      min-height: 78px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:6px;
      text-align:center;
      font-weight: 800;
    }

    .date-option small{
      display:block;
      font-weight: 650;
      opacity:.95;
      letter-spacing: .15px;
      line-height:1.25;
    }

    .date-option:hover{ filter: brightness(1.05); }
    .date-option:active{ transform: translateY(1px) scale(.99); }
    .date-option:focus-visible{ outline:none; box-shadow: 0 0 0 4px rgba(255,255,255,.22), 0 10px 26px rgba(0,0,0,.14); }

    .date-confirm{
      margin: 10px auto 0;
      max-width: 54ch;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(255,255,255,.22);
      border-radius: 18px;
      padding: 14px 14px;
      color: rgba(255,255,255,.98);
      text-shadow: 0 8px 22px rgba(0,0,0,.16);
      display:none;
    }

    .date-confirm.show{ display:block; }

    .date-confirm b{ font-weight: 900; }

    .date-confirm .cta{
      margin-top: 10px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      border:none;
      border-radius: 999px;
      padding: 12px 16px;
      background: rgba(255,255,255,.92);
      color: #2a0f1c;
      font-weight: 900;
      box-shadow: 0 12px 28px rgba(0,0,0,.16);
      cursor:pointer;
    }

    .date-confirm .cta:active{ transform: translateY(1px) scale(.99); }

    /* --- Selfie + Plan card (smaller + more impressive) --- */
    .selfie-wrap{
      margin-top: 14px;
      display:grid;
      gap:12px;
      justify-items:center;
    }

    .selfie-controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
    }

    .selfie-controls .cta{
      min-width: 150px;
      padding: 11px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.92);
      color: #2a0f1c;
      font-weight: 900;
      box-shadow: 0 12px 28px rgba(0,0,0,.16);
      cursor:pointer;
      border:none;
      text-decoration:none;
    }

    @media (max-width: 420px){
      .selfie-controls{ gap: 8px; }
      .selfie-controls .cta{
        min-width: 130px;
        padding: 10px 12px;
        font-size: 1rem;
      }

      .step-nav{ gap: 8px; }
      .step-nav .cta{
        padding: 10px 14px;
        font-size: 1rem;
      }

      .celebrate{ padding: 20px 14px; }
      .date-option{ min-height: 72px; }
    }

    /* Framed camera preview (small) */
    .selfie-stage{
      width: min(260px, 86vw);
      border-radius: 22px;
      padding: 10px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.22);
      box-shadow: 0 18px 40px rgba(0,0,0,.20);
      position:relative;
      overflow:hidden;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    .rose-bouquet{
      position:absolute;
      right:-22px;
      bottom:18px;
      font-size: 42px;
      transform: rotate(10deg);
      filter: drop-shadow(0 8px 14px rgba(0,0,0,.25));
      pointer-events:none;
      z-index: 2;
    }

    @media (max-width:420px){
      .rose-bouquet{
        right:-12px;
        bottom:12px;
        font-size: 34px;
      }
    }

    .selfie-stage::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(220px 140px at 16% 10%, rgba(255,255,255,.20), transparent 55%),
        radial-gradient(260px 160px at 86% 20%, rgba(255,47,122,.18), transparent 60%),
        radial-gradient(280px 180px at 50% 110%, rgba(255,209,227,.16), transparent 58%);
      pointer-events:none;
    }

    .selfie-video{
      position:relative;
      z-index:1;
      width: 100%;
      aspect-ratio: 3 / 4;
      border-radius: 16px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.18);
      object-fit: cover;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }

    /* Result image (still compact) */
    .selfie-result{
      width: min(320px, 92vw);
      border-radius: 22px;
      box-shadow: 0 22px 52px rgba(0,0,0,.24);
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.10);
    }

    .selfie-note{
      font-size: .98rem;
      opacity:.96;
      line-height:1.35;
      max-width: 52ch;
    }

    .selfie-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(255,255,255,.22);
      color: rgba(255,255,255,.98);
      font-weight: 850;
      letter-spacing:.15px;
      box-shadow: 0 12px 30px rgba(0,0,0,.16);
    }

    .selfie-error{
      margin-top: 8px;
      color: rgba(255,255,255,.96);
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.18);
      padding: 10px 12px;
      border-radius: 14px;
      display:none;
      max-width: 54ch;
    }
    .selfie-error.show{ display:block; }

    .hidden{ display:none !important; }

    .overlay .mini{
      margin-top: 12px;
      font-size: 1rem;
      opacity:.95;
    }

    /* Confetti + burst pieces */
    .confetti, .burst{
      position:absolute;
      inset:0;
      pointer-events:none;
      overflow:hidden;
    }
    .confetti i{
      position:absolute;
      width:10px;
      height:16px;
      border-radius: 3px;
      opacity:.95;
      transform: translate3d(0,-10vh,0) rotate(0deg);
      animation: fall linear forwards;
      will-change: transform, opacity;
    }
    @keyframes fall{
      0%   { transform: translate3d(var(--x,0), -12vh, 0) rotate(0deg); opacity:0; }
      10%  { opacity:1; }
      100% { transform: translate3d(calc(var(--x,0) + var(--drift, 0px)), 110vh, 0) rotate(var(--r, 720deg)); opacity:0.98; }
    }

    .burst .heart{
      position:absolute;
      width:14px;
      height:14px;
      background: rgba(255,255,255,.92);
      transform: rotate(45deg);
      border-radius: 3px;
      opacity:0;
      animation: pop 900ms ease-out forwards;
    }
    .burst .heart::before,
    .burst .heart::after{
      content:"";
      position:absolute;
      width:14px;
      height:14px;
      background: rgba(255,255,255,.92);
      border-radius: 50%;
    }
    .burst .heart::before{ left:-7px; top:0; }
    .burst .heart::after{ left:0; top:-7px; }

    @keyframes pop{
      0%   { transform: translate3d(0,0,0) rotate(45deg) scale(0.7); opacity:0; }
      15%  { opacity:1; }
      100% { transform: translate3d(var(--dx,0px), var(--dy,0px), 0) rotate(45deg) scale(1.15); opacity:0; }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      .bg-hearts .h, #yesBtn .shine::after, .confetti i, .burst .heart { animation: none !important; }
      body{ overflow:auto; }
    }
  </style>
</head>
<body>
  <div class="bg-hearts" aria-hidden="true" id="bgHearts"></div>
  <div class="heart-rain" aria-hidden="true" id="heartRain"></div>

  <main class="wrap" role="main">
    <section class="card" aria-label="Valentine question card" id="card">
      <div class="content">
        <h1>Will you be my Valentine? üíñ</h1>
        <p class="sub"><span class="type" id="typewriter"></span></p>
        <div class="rotate" id="rotateLine" aria-live="polite"></div>

        <div class="buttons" aria-label="Answer buttons area" id="btnArea">
          <button id="yesBtn" type="button" aria-label="Yes" disabled aria-disabled="true">
            Yes üòç
            <span class="shine" aria-hidden="true"></span>
          </button>

          <button id="noBtn" type="button" aria-label="No (not clickable)">
            No üôÑ
          </button>
        </div>

        <div class="hint" id="hint" aria-live="polite">
          (Psst‚Ä¶ only one of these is brave enough to stay put.)
        </div>
      </div>
    </section>

    <footer aria-label="Footer">
      Made with love ‚ù§Ô∏è
    </footer>
  </main>

  <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-label="Celebration">
    <div class="confetti" id="confetti" aria-hidden="true"></div>
    <div class="burst" id="burst" aria-hidden="true"></div>
    <div class="overlay-heart-rain" id="overlayHeartRain" aria-hidden="true"></div>

    <div class="celebrate">
      <h2>YAY!! üíïüíù Happy Valentine‚Äôs, my love!</h2>
      <p class="mini">Now let‚Äôs make it official üòÑ</p>

      <div class="date-chooser" id="dateChooser" aria-label="Choose our Valentine date">
        <div class="question">Pick our Valentine plan üëá</div>

        <div class="date-grid" role="group" aria-label="Valentine plan options">
          <button class="date-option" type="button" data-plan="Pizza + Movie">
            üçïüé¨
            <small>Pizza + Movie</small>
          </button>
          <button class="date-option" type="button" data-plan="Cafe + Walk">
            ‚òïüåô
            <small>Caf√© + Walk</small>
          </button>
          <button class="date-option" type="button" data-plan="Ice Cream + Photos">
            üç¶üì∏
            <small>Ice cream + Photos</small>
          </button>
          <button class="date-option" type="button" data-plan="Dinner + Roses">
            üçΩÔ∏èüåπ
            <small>Dinner + Roses</small>
          </button>
        </div>

        <div class="date-confirm" id="dateConfirm" aria-live="polite"></div>
      </div>

      <!-- Step 2: Selfie page (shown after choosing a plan) -->
      <div class="overlay-step" id="selfieStep" aria-label="Selfie with plan">
        <div class="date-confirm show" id="selfieConfirm" aria-live="polite"></div>
        <div class="step-nav">
          <button class="cta" type="button" id="backToPlansBtn">‚Üê Back to plans</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const card = document.getElementById('card');
      const btnArea = document.getElementById('btnArea');
      const yesBtn = document.getElementById('yesBtn');
      const noBtn  = document.getElementById('noBtn');
      const hint   = document.getElementById('hint');
      const typewriter = document.getElementById('typewriter');
      const rotateLine = document.getElementById('rotateLine');
      const heartRain = document.getElementById('heartRain');
      const overlayHeartRain = document.getElementById('overlayHeartRain');

      const overlay = document.getElementById('overlay');
      const confetti = document.getElementById('confetti');
      const burst = document.getElementById('burst');
      const dateChooser = document.getElementById('dateChooser');
      const dateConfirm = document.getElementById('dateConfirm');
      const selfieStep = document.getElementById('selfieStep');
      const selfieConfirm = document.getElementById('selfieConfirm');
      const backToPlansBtn = document.getElementById('backToPlansBtn');

      let selfieStream = null;
      let selectedPlan = null;

      // --- Subtle floating hearts background ---
      const bg = document.getElementById('bgHearts');
      const makeBgHearts = (count = 18) => {
        bg.innerHTML = '';
        for (let i = 0; i < count; i++) {
          const h = document.createElement('div');
          h.className = 'h';
          const left = Math.random() * 100;
          const delay = Math.random() * 8;
          const dur = 10 + Math.random() * 14;
          const size = 0.7 + Math.random() * 1.4;

          h.style.left = left + 'vw';
          h.style.top = (80 + Math.random() * 30) + 'vh';
          h.style.animationDuration = dur + 's';
          h.style.animationDelay = (-delay) + 's';
          h.style.setProperty('--s', size.toFixed(2));
          h.style.opacity = (0.35 + Math.random() * 0.35).toFixed(2);
          bg.appendChild(h);
        }
      };
      makeBgHearts(window.matchMedia('(max-width: 420px)').matches ? 14 : 18);
      window.addEventListener('resize', () => {
        makeBgHearts(window.matchMedia('(max-width: 420px)').matches ? 14 : 18);
      }, { passive: true });

      // --- Valentine intro: typewriter love note ---
      const lines = [
        "This Valentine‚Äôs‚Ä¶ I don‚Äôt want chocolates.",
        "I want you.",
        "So here‚Äôs my question‚Ä¶"
      ];

      function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

      async function typeLines() {
        typewriter.textContent = "";
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          for (let j = 0; j < line.length; j++) {
            typewriter.textContent += line[j];
            await sleep(18 + Math.random() * 26);
          }
          if (i !== lines.length - 1) typewriter.textContent += "\n";
          await sleep(280);
        }
      }
      typeLines();

      // --- Rotating cute lines ---
      const rotates = [
        "You‚Äôre my favorite notification üí¨",
        "Every love song reminds me of you üé∂",
        "My heart chose you ‚ù§Ô∏è",
        "Valentine without you? Impossible üò§",
        "Okay‚Ä¶ press YES when you‚Äôre ready üòè"
      ];
      let rIdx = 0;
      function tickRotate(){
        rotateLine.textContent = rotates[rIdx % rotates.length];
        rIdx++;
      }
      tickRotate();
      setInterval(tickRotate, 2600);

      // --- Heart shower (works on both main page + overlay) ---
      function spawnHeart(container, w){
        const b = document.createElement('b');
        const x = Math.random() * w;
        const dx = (Math.random() * 220 - 110);
        const dur = 2.3 + Math.random() * 2.4;
        const delay = Math.random() * 0.15;
        const s = 0.70 + Math.random() * 1.45;

        b.style.left = x + 'px';
        b.style.top = '-10vh';
        b.style.animationDuration = dur + 's';
        b.style.animationDelay = delay + 's';
        b.style.setProperty('--dx', dx.toFixed(0) + 'px');
        b.style.setProperty('--s', s.toFixed(2));
        container.appendChild(b);

        // cleanup after it finishes
        setTimeout(() => b.remove(), (dur + delay) * 1000 + 120);
      }

      function startHeartShower(container, rateMs = 220){
        if (!container) return null;
        // Avoid multiple timers
        if (container.__showerTimer) return container.__showerTimer;

        const tick = () => {
          const w = window.innerWidth;

          // Gentle base shower
          spawnHeart(container, w);

          // Overlay: a little extra, but keep it light
          if (container === overlayHeartRain) {
            if (Math.random() > 0.35) spawnHeart(container, w);
          } else {
            // Background: occasional extra heart
            if (Math.random() > 0.80) spawnHeart(container, w);
          }
        };

        tick();
        const t = setInterval(tick, rateMs);
        container.__showerTimer = t;
        return t;
      }

      function stopHeartShower(container){
        if (!container || !container.__showerTimer) return;
        clearInterval(container.__showerTimer);
        container.__showerTimer = null;
        container.innerHTML = '';
      }

      // Short burst (used when NO disappears)
      function burstHeartRain(container, n = 24){
        if (!container) return;
        const w = window.innerWidth;
        for (let i = 0; i < n; i++) {
          spawnHeart(container, w);
        }
      }

      // --- "No" button evasive behavior ---
      let attempts = 0;
      let lastMoveAt = 0;
      const MAX_ATTEMPTS = 5;

      // Place No in an initial safe spot
      const clamp = (v, min, max) => Math.min(max, Math.max(min, v));

      function randomizeNoPosition() {
        // ensure layout is measurable
        const areaRect = btnArea.getBoundingClientRect();
        const btnRect = noBtn.getBoundingClientRect();

        const padding = 10;
        const maxX = Math.max(padding, areaRect.width - btnRect.width - padding);
        const maxY = Math.max(padding, areaRect.height - btnRect.height - padding);

        const x = padding + Math.random() * (maxX - padding);
        const y = padding + Math.random() * (maxY - padding);

        // Position relative to btnArea
        noBtn.style.left = x + 'px';
        noBtn.style.top = y + 'px';
        noBtn.style.transform = 'none';
      }

      function hideNo() {
        noBtn.style.display = 'none';
        hint.textContent = "Okay okay‚Ä¶ Cupid deleted the 'No' button üíò";

        // Enable YES only after NO disappears
        yesBtn.disabled = false;
        yesBtn.setAttribute('aria-disabled', 'false');

        // Switch to Valentine Mode + heart rain
        document.body.classList.add('valentine-mode');
        burstHeartRain(heartRain, window.matchMedia('(max-width: 420px)').matches ? 22 : 34);
        setTimeout(() => burstHeartRain(heartRain, window.matchMedia('(max-width: 420px)').matches ? 18 : 28), 520);

        yesBtn.focus({ preventScroll: true });
      }

      function moveNo(reason) {
        const now = performance.now();
        if (now - lastMoveAt < 160) return; // debounce jitter
        lastMoveAt = now;

        attempts++;
        if (attempts >= MAX_ATTEMPTS) {
          hideNo();
          return;
        }

        randomizeNoPosition();

        const remaining = MAX_ATTEMPTS - attempts;
        hint.textContent =
          remaining === 1
            ? "So close‚Ä¶ one more try üòè"
            : `Nice try üòõ (${remaining} tries left)`;
      }

      function distPointToRect(px, py, rect) {
        const dx = Math.max(rect.left - px, 0, px - rect.right);
        const dy = Math.max(rect.top - py, 0, py - rect.bottom);
        return Math.hypot(dx, dy);
      }

      function maybeEvadeFromPointer(clientX, clientY) {
        if (noBtn.style.display === 'none') return;
        const rect = noBtn.getBoundingClientRect();
        const d = distPointToRect(clientX, clientY, rect);
        // "Proximity" threshold
        const threshold = 70; // px
        if (d <= threshold) moveNo('proximity');
      }

      // Mouse move proximity
      card.addEventListener('mousemove', (e) => {
        maybeEvadeFromPointer(e.clientX, e.clientY);
      }, { passive: true });

      // Pointer move proximity (covers touch hover-ish + stylus)
      card.addEventListener('pointermove', (e) => {
        // Only if pointer is in contact or on devices that support hover
        if (e.pointerType === 'mouse' || e.pressure > 0) {
          maybeEvadeFromPointer(e.clientX, e.clientY);
        }
      }, { passive: true });

      // Touch/pointer: if tap near the No button, it moves away
      card.addEventListener('pointerdown', (e) => {
        if (noBtn.style.display === 'none') return;
        // Do not interfere with clicking Yes
        if (e.target === yesBtn) return;
        maybeEvadeFromPointer(e.clientX, e.clientY);
      }, { passive: true });

      // Also evade if finger lands in the buttons area (common on mobile)
      btnArea.addEventListener('touchstart', (e) => {
        if (noBtn.style.display === 'none') return;
        const t = e.touches && e.touches[0];
        if (!t) return;
        maybeEvadeFromPointer(t.clientX, t.clientY);
      }, { passive: true });

      // Initial random position after first paint to ensure accurate sizes
      requestAnimationFrame(() => randomizeNoPosition());

      // --- Celebration: confetti + heart burst + optional sound on YES click ---
      function rand(min, max){ return min + Math.random() * (max - min); }

      function makeConfettiPieces(n = 120) {
        confetti.innerHTML = '';
        const w = window.innerWidth;

        for (let i = 0; i < n; i++) {
          const p = document.createElement('i');

          // No fixed color scheme: random bright-ish HSL
          const hue = Math.floor(rand(0, 360));
          const sat = Math.floor(rand(70, 95));
          const light = Math.floor(rand(55, 72));
          p.style.background = `hsl(${hue} ${sat}% ${light}%)`;

          const x = Math.floor(rand(0, w));
          const drift = Math.floor(rand(-120, 120));
          const dur = rand(2.2, 4.6);
          const delay = rand(0, 0.8);
          const rot = `${Math.floor(rand(540, 1200))}deg`;
          const scale = rand(0.75, 1.4);

          p.style.left = x + 'px';
          p.style.top = '-12vh';
          p.style.transform = `translate3d(0,-12vh,0) rotate(0deg) scale(${scale})`;
          p.style.animationDuration = dur + 's';
          p.style.animationDelay = delay + 's';
          p.style.setProperty('--x', x + 'px');
          p.style.setProperty('--drift', drift + 'px');
          p.style.setProperty('--r', rot);

          confetti.appendChild(p);
        }

        // Clean up after animation
        setTimeout(() => { confetti.innerHTML = ''; }, 6000);
      }

      function makeHeartBurst(cx, cy, count = 26) {
        burst.innerHTML = '';
        const rect = overlay.getBoundingClientRect();
        const x0 = cx ?? rect.width / 2;
        const y0 = cy ?? rect.height / 2;

        for (let i = 0; i < count; i++) {
          const h = document.createElement('div');
          h.className = 'heart';
          const angle = rand(0, Math.PI * 2);
          const radius = rand(70, 240);
          const dx = Math.cos(angle) * radius;
          const dy = Math.sin(angle) * radius;

          h.style.left = (x0 - 7) + 'px';
          h.style.top = (y0 - 7) + 'px';
          h.style.setProperty('--dx', dx.toFixed(1) + 'px');
          h.style.setProperty('--dy', dy.toFixed(1) + 'px');
          h.style.animationDelay = rand(0, 0.12) + 's';

          burst.appendChild(h);
        }

        setTimeout(() => { burst.innerHTML = ''; }, 1200);
      }

      // Optional click-sound (generated, no external asset)
      async function playTinyCelebrationSound() {
        try {
          const AudioCtx = window.AudioContext || window.webkitAudioContext;
          if (!AudioCtx) return;
          const ctx = new AudioCtx();
          // Must resume on user gesture; if blocked, this will throw or remain suspended
          await ctx.resume();

          const now = ctx.currentTime;

          const master = ctx.createGain();
          master.gain.setValueAtTime(0.0001, now);
          master.gain.exponentialRampToValueAtTime(0.25, now + 0.02);
          master.gain.exponentialRampToValueAtTime(0.0001, now + 0.75);
          master.connect(ctx.destination);

          // A short "sparkle" chord
          const freqs = [523.25, 659.25, 783.99]; // C5 E5 G5
          freqs.forEach((f, idx) => {
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.type = 'sine';
            o.frequency.setValueAtTime(f, now);
            o.frequency.exponentialRampToValueAtTime(f * 2, now + 0.18);

            g.gain.setValueAtTime(0.0001, now);
            g.gain.exponentialRampToValueAtTime(0.22, now + 0.02);
            g.gain.exponentialRampToValueAtTime(0.0001, now + (0.28 + idx * 0.06));

            o.connect(g);
            g.connect(master);

            o.start(now + idx * 0.02);
            o.stop(now + 0.45 + idx * 0.06);
          });

          // Close after short time to free resources
          setTimeout(() => ctx.close().catch(() => {}), 1100);
        } catch (_) {
          // If blocked by browser policy, do nothing.
        }
      }

      function showCelebration(e) {
        overlay.classList.add('show');

        // Start heart shower on the overlay too
        startHeartShower(overlayHeartRain, window.matchMedia('(max-width: 420px)').matches ? 220 : 180);

        // Reset chooser UI each time
        // Step/page reset
        if (dateChooser) dateChooser.classList.remove('hidden');
        if (selfieStep) selfieStep.classList.remove('show');

        if (dateConfirm) {
          dateConfirm.classList.remove('show');
          dateConfirm.innerHTML = '';
        }
        if (selfieConfirm) {
          selfieConfirm.innerHTML = '';
        }

        // Confetti quantity adapts to device
        const pieces = window.matchMedia('(max-width: 420px)').matches ? 100 : 150;
        makeConfettiPieces(pieces);

        // Heart burst at click location (or center)
        let cx = null, cy = null;
        if (e && typeof e.clientX === 'number') {
          cx = e.clientX;
          cy = e.clientY;
        }
        makeHeartBurst(cx, cy, 30);

        // Additional bursts
        setTimeout(() => makeHeartBurst(null, null, 26), 250);
        setTimeout(() => makeHeartBurst(null, null, 26), 520);

        // Optional sound (only on click)
        playTinyCelebrationSound();

        // Accessibility: move focus to overlay headline
        // (Create a temporary focus target)
        const h2 = overlay.querySelector('h2');
        h2.setAttribute('tabindex', '-1');
        h2.focus({ preventScroll: true });

        // Prevent scrolling behind overlay on some mobile browsers
        document.body.style.overflow = 'hidden';
      }

      // --- Valentine surprise: choose our date plan ---
      function setPlan(plan){
        selectedPlan = plan;
        try { localStorage.setItem('valentine_plan', plan); } catch(_) {}

        // Step 2 (next page): show selfie page
        if (dateChooser) dateChooser.classList.add('hidden');
        if (selfieStep) selfieStep.classList.add('show');

        if (!selfieConfirm) return;

        selfieConfirm.innerHTML = `
          ‚úÖ Deal! Our plan is <b>${plan}</b> üíò
          <div class="selfie-wrap">
            <div class="selfie-note">Take a selfie with our plan and we‚Äôll have it on one page ü•∞</div>

            <div class="selfie-controls">
              <button class="cta" type="button" id="startSelfieBtn">Open camera üì∑</button>
              <button class="cta" type="button" id="captureSelfieBtn" disabled>Take selfie ‚ú®</button>
              <button class="cta" type="button" id="stopSelfieBtn" disabled>Close camera</button>
            </div>

            <div class="selfie-badge">üì∑ Selfie with the plan</div>
            <div class="selfie-stage">
              <video class="selfie-video hidden" id="selfieVideo" autoplay playsinline muted></video>
              <div class="rose-bouquet">üíêüåπ</div>
            </div>
            <canvas id="selfieCanvas" class="hidden"></canvas>

            <img class="selfie-result hidden" id="selfieResult" alt="Selfie with plan" />

            <div class="selfie-controls">
              <a class="cta hidden" id="downloadSelfieBtn" download="valentine-plan-selfie.png" href="#">Download ü´∂</a>
            </div>

            <div class="selfie-error" id="selfieError"></div>
          </div>
        `;

        // Small extra celebration burst
        makeHeartBurst(null, null, 18);
        setTimeout(() => makeHeartBurst(null, null, 16), 220);

        const startBtn = document.getElementById('startSelfieBtn');
        const captureBtn = document.getElementById('captureSelfieBtn');
        const stopBtn = document.getElementById('stopSelfieBtn');
        const video = document.getElementById('selfieVideo');
        const canvas = document.getElementById('selfieCanvas');
        const resultImg = document.getElementById('selfieResult');
        const dl = document.getElementById('downloadSelfieBtn');
        const err = document.getElementById('selfieError');

        const showError = (msg) => {
          if (!err) return;
          err.textContent = msg;
          err.classList.add('show');
        };

        const clearError = () => {
          if (!err) return;
          err.textContent = '';
          err.classList.remove('show');
        };

        const stopStream = () => {
          if (selfieStream) {
            try {
              selfieStream.getTracks().forEach(t => t.stop());
            } catch(_) {}
          }
          selfieStream = null;
          if (video) {
            try { video.srcObject = null; } catch(_) {}
            video.classList.add('hidden');
          }
          if (captureBtn) captureBtn.disabled = true;
          if (stopBtn) stopBtn.disabled = true;
          if (startBtn) startBtn.disabled = false;
        };

        const startCamera = async () => {
          clearError();
          // Most browsers require HTTPS to access camera.
          // Works on localhost / https; may be blocked on file://
          try {
            const isMobile = window.matchMedia('(max-width: 520px)').matches;
            const constraints = {
              video: {
                facingMode: 'user',
                width: { ideal: isMobile ? 720 : 900 },
                height: { ideal: isMobile ? 960 : 1200 }
              },
              audio: false
            };

            selfieStream = await navigator.mediaDevices.getUserMedia(constraints);
            if (video) {
              video.srcObject = selfieStream;
              video.classList.remove('hidden');
            }
            if (captureBtn) captureBtn.disabled = false;
            if (stopBtn) stopBtn.disabled = false;
            if (startBtn) startBtn.disabled = true;
          } catch (e) {
            showError("Camera permission was blocked. Tip: run this page on HTTPS (or localhost) to use the selfie feature.");
            stopStream();
          }
        };

        const drawComposite = () => {
          if (!video || !canvas || !resultImg) return;

          // Video metadata might not be ready
          const vw = video.videoWidth || 720;
          const vh = video.videoHeight || 960;

          // Create a nice portrait card
          const outW = 900;
          const outH = 1200;
          canvas.width = outW;
          canvas.height = outH;

          const ctx = canvas.getContext('2d');
          if (!ctx) return;

          // Background gradient
          const g = ctx.createLinearGradient(0, 0, outW, outH);
          g.addColorStop(0, '#ff2f7a');
          g.addColorStop(0.55, '#ff6aa8');
          g.addColorStop(1, '#ffd1e3');
          ctx.fillStyle = g;
          ctx.fillRect(0, 0, outW, outH);

          // Photo area
          const pad = 48;
          const photoX = pad;
          const photoY = 150;
          const photoW = outW - pad * 2;
          const photoH = outH - photoY - 220;

          // Draw rounded photo
          const r = 32;
          ctx.save();
          ctx.beginPath();
          ctx.moveTo(photoX + r, photoY);
          ctx.arcTo(photoX + photoW, photoY, photoX + photoW, photoY + photoH, r);
          ctx.arcTo(photoX + photoW, photoY + photoH, photoX, photoY + photoH, r);
          ctx.arcTo(photoX, photoY + photoH, photoX, photoY, r);
          ctx.arcTo(photoX, photoY, photoX + photoW, photoY, r);
          ctx.closePath();
          ctx.clip();

          // Cover-crop the selfie into the photo box
          const scale = Math.max(photoW / vw, photoH / vh);
          const sw = photoW / scale;
          const sh = photoH / scale;
          const sx = (vw - sw) / 2;
          const sy = (vh - sh) / 2;
          ctx.drawImage(video, sx, sy, sw, sh, photoX, photoY, photoW, photoH);
          ctx.restore();

          // Bouquet overlay (so it shows up on the downloadable image too)
          ctx.save();
          ctx.font = '72px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"';
          ctx.textAlign = 'right';
          ctx.textBaseline = 'bottom';
          ctx.shadowColor = 'rgba(0,0,0,.28)';
          ctx.shadowBlur = 14;
          ctx.shadowOffsetX = 0;
          ctx.shadowOffsetY = 8;

          // Place in bottom-right of the photo area
          const bouquetX = photoX + photoW - 10;
          const bouquetY = photoY + photoH - 6;
          ctx.fillText('üíêüåπ', bouquetX, bouquetY);
          ctx.restore();

          // Title
          ctx.fillStyle = 'rgba(255,255,255,.98)';
          ctx.font = '900 54px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
          ctx.textAlign = 'center';
          ctx.fillText("Valentine‚Äôs Plan üíò", outW / 2, 88);

          // Plan badge
          const badgeY = outH - 140;
          ctx.fillStyle = 'rgba(255,255,255,.92)';
          const bw = outW - pad * 2;
          const bh = 90;
          const bx = pad;
          const by = badgeY;
          const br = 24;
          ctx.beginPath();
          ctx.moveTo(bx + br, by);
          ctx.arcTo(bx + bw, by, bx + bw, by + bh, br);
          ctx.arcTo(bx + bw, by + bh, bx, by + bh, br);
          ctx.arcTo(bx, by + bh, bx, by, br);
          ctx.arcTo(bx, by, bx + bw, by, br);
          ctx.closePath();
          ctx.fill();

          ctx.fillStyle = '#2a0f1c';
          ctx.font = '900 40px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
          ctx.textAlign = 'center';
          ctx.fillText(selectedPlan || plan, outW / 2, by + 58);

          // Export
          const dataUrl = canvas.toDataURL('image/png');
          resultImg.src = dataUrl;
          resultImg.classList.remove('hidden');
          if (dl) {
            dl.href = dataUrl;
            dl.classList.remove('hidden');
          }
        };

        const capture = () => {
          clearError();
          if (!selfieStream) {
            showError('Open camera first üôÇ');
            return;
          }
          // Ensure video has data
          if (video && (video.readyState < 2)) {
            showError('Camera is warming up‚Ä¶ try again in a second üòÑ');
            return;
          }
          drawComposite();
          stopStream();
        };

        if (startBtn) startBtn.addEventListener('click', startCamera);
        if (stopBtn) stopBtn.addEventListener('click', stopStream);
        if (captureBtn) captureBtn.addEventListener('click', capture);
      }

      // Event delegation for the option buttons
      if (dateChooser) {
        dateChooser.addEventListener('click', (ev) => {
          const btn = ev.target && ev.target.closest && ev.target.closest('.date-option');
          if (!btn) return;
          const plan = btn.getAttribute('data-plan') || btn.textContent.trim();
          setPlan(plan);
        });
      }

      if (backToPlansBtn) {
        backToPlansBtn.addEventListener('click', () => {
          // Stop camera if open
          if (selfieStream) {
            try { selfieStream.getTracks().forEach(t => t.stop()); } catch(_) {}
            selfieStream = null;
          }

          // Reset selfie UI
          if (selfieConfirm) selfieConfirm.innerHTML = '';

          // Show plan chooser again
          if (selfieStep) selfieStep.classList.remove('show');
          if (dateChooser) dateChooser.classList.remove('hidden');
        });
      }

      yesBtn.addEventListener('click', showCelebration);
      yesBtn.addEventListener('click', (e) => {
        if (yesBtn.disabled) {
          e.preventDefault();
          hint.textContent = "Try catching the 'No' first üòè";
        }
      });

      // Allow closing overlay via Escape (nice for desktop)
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && overlay.classList.contains('show')) {
          overlay.classList.remove('show');
          document.body.style.overflow = '';
          // reset celebration layers
          confetti.innerHTML = '';
          burst.innerHTML = '';
          if (dateConfirm) {
            dateConfirm.classList.remove('show');
            dateConfirm.innerHTML = '';
          }
          if (selfieStep) selfieStep.classList.remove('show');
          if (selfieConfirm) selfieConfirm.innerHTML = '';
          if (dateChooser) dateChooser.classList.remove('hidden');
          stopHeartShower(overlayHeartRain);
          // stop camera if open
          if (selfieStream) {
            try { selfieStream.getTracks().forEach(t => t.stop()); } catch(_) {}
            selfieStream = null;
          }
          // restore focus to yes button
          yesBtn.focus();
        }
      });

      // Keep "No" inside bounds if device rotates
      window.addEventListener('resize', () => {
        if (noBtn.style.display === 'none') return;
        // Re-clamp current position if needed
        const areaRect = btnArea.getBoundingClientRect();
        const btnRect = noBtn.getBoundingClientRect();

        // current relative position
        const left = parseFloat(noBtn.style.left || '0');
        const top = parseFloat(noBtn.style.top || '0');

        const padding = 10;
        const maxX = Math.max(padding, areaRect.width - btnRect.width - padding);
        const maxY = Math.max(padding, areaRect.height - btnRect.height - padding);

        noBtn.style.left = clamp(left, padding, maxX) + 'px';
        noBtn.style.top = clamp(top, padding, maxY) + 'px';
        noBtn.style.transform = 'none';
      }, { passive: true });

      // Start a gentle heart shower on the main page
      startHeartShower(heartRain, window.matchMedia('(max-width: 420px)').matches ? 560 : 460);

      // If user tries to select text/drag, keep it smooth
      document.addEventListener('dragstart', (e) => e.preventDefault());
    })();
  </script>
</body>
</html>